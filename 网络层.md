# 网络层

网际协议IP，理解网络互连问题。网际控制报文协议ICMP，常见的路由协议，IPv6的主要特点。IP数据报=分组

网络层向上只提供**灵活的、无连接的、尽最大努力交付的数据报服务**。网络层不提供服务质量的承诺，即不可靠交付；**由主机端通信的运输层负责差错处理、流量控制等**。



**网际协议IP**



**虚拟互连网络**：将网络互相连通起来需要一些中间设备：

（1）转发器：物理层使用的中间设备

（2）网桥（桥接器）：数据链路层

（3）路由器：网络层

（4）网关：网络层以上，连接两个不兼容的系统，并且需要高层的协议转换

不同异构的网络通过这些中间设备连接起来，利用IP协议使这些异构的网络在网络层上看起来是统一的网络，则称之为互联网；



**IP地址**：给每一台主机或路由器的**每一个接口**分配一个全世界范围**唯一**的**32位的标识符**

ICANN：互联网名字和数字分配机构

IP地址的编址方式：IP地址 ::= 网络号（唯一）+主机号

（1）分类的IP地址（2）子网的划分 （3）构成超网（无分类编址）

A类：0+7 网络号 24 主机号 最大主机数2^24-2（全0是本机 全1是所有主机）(1-126)

B类：10+14 网络号 16主机号 最大主机数2^16-2（128.1-191.255）

C类：110+21 网络号 8 主机号 最大主机数2^82（192.0.1-255.255.255）

D类：1110+28 多播地址

E类：1111+28 保留以后

***图 4-3 P121***

**IP地址特点**：

（1）**IP地址只分配网络号**，**路由器只根据主机所连接网络号来转发分组**，减少了路由表所占存储空间和差值路由表时间

（2）1个路由器至少有**2个IP地址**，IP地址标志一台主机和一条链路的接口

（3）用**转发器或网桥连接的若干局域网仍是一个网络**

（4）IP地址中所有分配的网络号**平等**



IP地址和硬件地址：

**IP地址在IP数据报首部；IP地址的IP数据报交给数据链路层就被封装成MAC帧；MAC帧在传送时使用的源地址和目的地址都是硬件地址，这两个硬件地址都在MAC帧首部；**

**MAC帧的首部尾部剥去后把MAC层的数据上交到网络层后，网络层才能在IP数据报首部找到源IP得知和目的IP地址；**

**在网络层和以上都是使用IP地址，数据链路层及以下使用MAC帧的数据**

***图 4-9b 122***



**ARP地址协议ARP：已经知道机器的IP地址，找到相应的硬件地址**，从网络层使用的IP地址，解析出数据链路层使用的硬件地址；在主机**ARP高速缓存**中存放一个从**IP地址到硬件地址的映射表**，并且经常动态更新（新增或超时删除）；主机对这种地址解析过程是不知道的，ARP是解决同一局域网上的主机或路由器；

由于全世界有各种各样的硬件地址，转换十分麻烦，所以统一使用IP编址；



**IP数据报格式**

IP协议版本4位（IPv4/6）、首部长度4位、区分服务8位、总长度16位（65535字节）、标识16位、标志3位（MF是还有分片或DF不能分片）、片偏移13位（以8个字节为偏移单位，长分组分片后，相对于元分组的相对位置）、生存时间8位、协议8位，首部检验和16位（计算数据报首段和然后取反码看是否等于0）、源地址目的地址都是16位

Ip层数据报总长度**不能超过数据链路层规定的最大传送单元MTU**（一般是1500字节），IP协议规定所有主机、路由器**必须接受长度不超过576字节的数据报**；



**IP层转发分组流程**

IP数据报仅有源地址和目标地址的IP地址，首先是主机的路由器，但是并没有完整的路径；如果目的地址与路由器直接相连，则直接交付；否则把数据报先传给路由表中指明的下一跳路由器，然后继续向后传输总能到达目标地址。



**划分子网**：两级地址到三级地址（网络号、子网号、主机号），相当于在IP地址的主机号再划分，不改变IP得知原来的网络号；

**子网掩码**：在IP地址本书无法看见子网划分消息，如何数据报到了路由器然后转发导相应子网呢，这时候需要子网掩码；从原来的16位主机号，拿8位作为子网号；24个1+8个0，前16位网络号加8位子网号，**子网掩码8个0代表主机号**，子网掩码和数据报的目的IP地址逐为相“与”得到子网网络地址；主机号全为0

A类地址默认子网掩码255.**0.0.0**，0xFF000000（32位2进制，8位16进制）24位主机号

B类地址默认子网掩码255.255.**0.0**，0xFFFF0000（32位2进制，8位16进制）16位主机号

C类地址默认子网掩码255.255.255.**0**，0xFFFFFF00（32位2进制，8位16进制）8位主机号



分组转发：

（1）从收到的数据报获得目的IP地址D

（2）判断能都直接交付，对路由器直接相连的网络检查：用各网络的子网掩码与D逐位相与，结果为N；若N与目的网络地址匹配，则把分组直接交付，将D转换成物理地址，包数据报封装成帧发送，转发任务结束；否则执行

（3）若路由表中有目的地址为D的特定主机路由，把数据报传输给路由表中所指明下一跳路由器，否则执行

（4）对路由表中每一行用其中的子网掩码和D逐位相与，结果为N，N与该行网络地址撇皮，数据报传送给该行指明的下一跳路由器；否则执行

（5）若路由表有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行

（6）报告转发分组出错



划分子网耗尽，需要CIDR无分类编址，消除ABC类地址和划分子网概念；IP地址 ::= 网络前缀+主机号

如128.13.32.0/20 的地址掩码前20位是网络前缀，也是地址掩码的20个1+12个0，则还有2^12个地址；

**最长匹配前缀**：在查找路由表匹配时可能不止一个匹配，选择最长前缀匹配；

**二叉线索查找路由器**：找出每个IP地址对应的唯一前缀，构造二叉搜索；



**网际控制报文协议ICMP**：在IP数据报的数据部分，ICMP报文有差错报告报文和询问报文；

ICMP报文格式：类型、代码、检验和

（1）**差错报文**：Ip数据报的首部和数据字段的前8字节+差错报告前8字节；

终点不可达：路由器或主机无法交付数据，向源点发送终点不可达

时间超过：生存时间为0

参数问题：数据报首部字段值不值正确，丢弃；

改变路由（重定向）：将数据报发送给另外的路由；

（2）**询问报文**：

会送请求和回答：主机或路由器向一个特定的目的主机发出询问；

时间戳请求和回答：请某台主机或路由器回答当前当前日期时间；

ICMP应用：PING



**网际组管理协议IGMP**：传送多播数据报，让连接在本地局域网的多播路由器知道本局域网上是否有主机参加或推出了某个多播组；多播路由选择协议：将多播数据报用最小代价传送到所有的组成员



**路由选择协议**：路由表的路由如何得出；

（1）内部网关协议IGP：在一个自治系统内部选择协议，如RIP、OSPF

**路由信息协议RIP**：基于距离向量（跳数<16）的路由选择，只适用小型网络，**选择最少路由器路径**，**仅有相邻路由器交换信息，本路路由器有全部信息，固定时间间隔交换路由信息**（3个特点）；P155距离向量算法；每个路由信息是20个字节，一个报文最多25个路由，版本4字节，报文最大长度4+20x25=504；

**开发最短路径优先OSPF**：为了克服PIR缺点（网络故障时，要很长时间才能通知所有路由器），使用分布式的链路状态协议；OSPF和RIP三个特点都不一样，所有路由器发送消息（洪泛法），**路由器只知道所有相邻路由器的链路状态，只有链路状态变化时候才使用洪泛法更新消息**；5个分组请求：**问候、数据库描述、链路状态请求、链路状态更新、链路状态确认**；

（2）外部网关协议EGP：源主机和目的主机不在一个自治系统

理想的路由算法：

算法必须正确和完整

算法计算简单

能适应通信量和网络拓扑的变化

稳定性

公平

最佳

边界网关协议BGP：交换的网络可达的信息到达某个网络所经过一系列自治系统；



路由器构成：多个输入端口和多个输出端口；**路由部分+分组转发部分（交换结构+输入端口+输出端口）**

输入端口：从线路接受分组、物理层处理、数据链路层处理、网络层处理分组排队（查表转发）、交换结构

输出端口：交换结构、网络层处理分组排队（查表转发）、数据链路层、物理层、向线路发送分组



虚拟网络专用网VPN：用于机构内部通信，通信保密