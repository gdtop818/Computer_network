# 互联网概述

计算机网络（**网络**）：**结点**（node）+连接结点的**链路**（link）组成。 结点：**计算机、集线器、路由器、交换机**。

互**连**网（**网络的网络**）：网络之间由**路由器**互连起来。

**主机**（host）：与网络相连的**计算机**或**智能手机**。



互联网**三个阶段**：

​	第一阶段：单个网络**ARPANET**（TCP/IP协议）到互连网；

​	第二阶段：**三级结构**的互连网：主干网、地区网、校园网（企业网）；

​	第三阶段：**多层次ISP结构**的互联网；（ISP互联网服务提供者，移动电信联通）；通过ISP给客户分配IP；

​					互联网交换点IXP：允许两个网络直接相连并交换分组，不需要第三个网络来转发；***图 1-3 P7***



**互联网协会**（ISOC）：下属互联网体系结构委员会IAB下两个工程部：

​	互联网工程部IETF：分为多个工作组WG，每组由互联网工程指导小组IESG管理，分管不同工程；

​	互联网研究部IRTF：分为多个研究组RG，每组由互联网研究指导小组IRSG管理，研究一些长期问题，互联网协									议、应用、体系；

**互联网文档**（RFC）制定标准过程：

​	互联网草案（有效期6月）；建议标准（正式成为RFC文档）；互联网标准（每个标准一个编号STD 83）。



**互联网的组成**：***图 1-6 P10***

（1）边缘部分（端系统）：所有连接互联网的**主机**组成（用户直接使用，**通信和资源共享**）；主机A的某个进程									和主机B上的另一个进程进行通信（计算机之间的通信：**客户服务器CS方式/P2P对等方式**）

客户服务器方式（**客户和服务器都是指计算机进程或计算机软件**）：

​	客户是**服务请求方**，①用户调用后，通信时向服务器请求服务（必须**知道服务器程序地址**）②不需要特殊硬件

​	服务器是**服务提供方**，①专门提供某种服务的程序，可以**同时处理多个用户**②不断运行，一般不需要客户地址

对等连接方式（peer-2-peer）：不分服务请求和服务提供，同时**是请求方也是服务方**，是客户也是服务器；

（2）核心部分：大量**网络**和连接这些网络的**路由器**组成（为边缘部分提提供服务，**连通性和交换**）；

路由器（router）：实现**分组交换**（packet switching）的关键组件，接受**分组暂存**，**检查首部并查找转发表**，按照**首部的目标地址**，转发收到的分组到下一个路由器，传输过程中动态调整带宽，最终到目的主机；（各路由器**交换彼此路由信息**以便创建和动态维护路由器转发表）

交换（switching）：按某种方式**动态分配传输线路的资源**；

分组交换（packet switching）：采用**存储转发**技术，发送的整块数据为**报**文（message），将报文分割成一个个**等长数据段**，加上控制信息组成的**首部**（head），形成了一个**分组**（packet）；分组也称为“**包**”，首部为“**包头**”； ***图 1-13 P17***



**计算机网络类型**：

（1）作用范围：**广域网WAN**（几十到几千km）、城域网MAN（5-50km城市）、**局域网LAN**（小型工作站）、**个人区域网PAN**（10m左右）

（2）网络使用者：公用网（缴费即用）、专用网（满足特殊需要）

（3）用户接入到互联网的网络：接入网AN（本地&居民）



**计算机网络性能**：（10MB：10Mx8字节，10Mbit/s：比特）

（1）速率：bit/s，**bps**，数据的传送速率（数据率/比特率）；当提到速率，往往是额定速率或标称速率；

（2）带宽：**单位时间信道通过的最高数据率**，bps（原来指信号具有的频带宽度，赫兹Hz）；

（3）吞吐量：单位时间通过的实际数据率，每秒的字节数或帧数；

（4）**时延delay/latency：数据从一端到另一端的所需时间。** ***图1-14 P23***

​	发送时延：数据帧长度bit / 发送速率bps

​	传播时延（外部传输网线）：信道长度m / 电磁波在信道传输速率m/s

​	处理时延：主机或者路由器收到分组花费时间

​	排队时延：分组进入路由器后再输入队列等待处理

**并非发送速率高，总时延小，要看谁起主导地位；**

（5）时延带宽积：传播时延 x 带宽

（6）往返时间RTT 

有效数据率：数据长度 / （发送时间+RTT）

（7）利用率：

​	信道利用率：信道有多少时间是有数据通过

​	网络利用率：全网络信道利用率的加权平均

**利用率不是越大越好，根据排队理论，利用率大，时延大；**

D0是网络空闲时延，D是当前时延，利用率U：D = D0 / （1-U）



**5层协议的体系结构**：

（1）应用层：最高层，通过应用**进程间的交互来完成特定的网络应用**，定义**应用进程间通信和交互的规则**。进程：正在运行的程序。如：域名系统DNS、HTTP协议、SMTP协议，应用层交互的数据单元称为报文；

（2）运输层：**两台主机中进程之间的通信**提供通用的**数据传输服务**。应用进程利用该服务传送应用层报文；由于一台主机可以同时运行多个进程，**复用是多个进程可以同时使用运输层服务，分用是运输层把收到信息分别交付给应用层的相应进程；**

​	传输控制协议TCP：面向连接、可靠地数据传输服务，数据传输单位是**报文段**；

​	用户数据报协议UDP：无连接、尽最大努力的数据传输服务（**不保证可靠性**），数据传输单位是**用户数据报**；

（3）网络层（网际层、IP层）：负责为**分组交换网上不同主机提供通信服务**。发送数据时，把运输层产生的报文段或用户数据报封装成包或分组（IP数据报）进行传送，传输时选择合适的路由，协议是网际协议IP；

（4）（数据）链路层：两个**相邻节点传送数据**，在**链路传送**，**把数据链路层将网络层交下来的IP数据报组装成帧**，每一帧包括数据信息和控制信息（如同步信息，地址信息、差错控制等），检错并纠错；

（5）物理层：数据单位是bit。



实体：任何可发送或接受信息的硬件或软件过程；

协议：控制两个对等实体进行通信的规则集合；（语法定义交换信息格式，语义定义接收发送者操作）

服务：协议控制下，两个对等实体间的通信要使本层向上层提供服务；相邻两层交换信息地方叫服务访问点SAP；

TCP/IP路由器没有应用层和运输层；



# 物理层：确定媒体的接口特性，消除通信差异

物理层主要任务是**确定与传输媒体的接口有关的一些特性**，怎样在连接各种计算机地传输媒体上传输数据比特流，**传输媒体和通信种类多**，物理层要尽可能**屏蔽这些传输媒体和通信手段的差异**，**让物理层上的数据链路层感受不到这些差异**。

机械特性：接口所用接线器形状、尺寸、引脚数目、排列、固定、锁定装置；

电气特性：接口电缆的各条线上出现的电压范围；

功能特性：指明这条线上出现的某一电平电压意义；

过程特性：不同功能各种可能事件的出现顺序。



**数据通信系统**：**源系统、传输系统、目的系统**

**（1）源系统（发生端、发送方）**

源点（源站、信源）：源点设备**产生要传输的数据**；

发送器：**源点生成的数字比特**流经过**发送器编码**后才能在传输系统传输，如调制器；

（2）传输系统

（3）目的系统（接收端、接收方）

接收器：接受传输系统传送的信号，**转换为能被目的设备处理的信息**，如解调器模拟信号解调，并还原发送端产生的数字比特流；

终点（目的站、信宿）：终点设备从接收器获取传送的**数字比特流**，然后把信息**输出**。



**信号**：

（1）模拟信号（连续信号）：解调器到电话端

（2）数字信号（离散信号）：计算机到解调器之间，**代表不同离散数值的基本波形叫码元**

**信道channel**：向某一个方向传输信息的媒体；从双方信息交互方式看（**通信方式**），有以下三种：

（1）单向通信（单工通信）：只有一个方向的通信，无反方向交互；

（2）双向交替通信（半双工通信）：通信双方都能发送，但是不能同时发送，也不能同时接受；一发一收；

（3）双向同时通信（全双工通信）

**调制**：信号在信道上传输需要经过调制。**来源于信源的信号叫基带信号，往往有低频分量或直流分量，而许多信道不能传输，所以需要调制**。

（1）**基带调制**（编码）：仅仅对**基带信号的波形**进行**变换**

​	不归零制：正负电平

​	归零制：正负脉冲

​	曼彻斯特：周期中心上跳0，下跳1

​	差分曼彻斯特：变节有跳变0，无跳变1

（2）**带通调制**：使用**载波进行调制**，把基带信号的频率搬到更高的频段，转换为模拟信号。

调幅AM：载波幅度； 调频FM：载波频率；调相PM：载波初始相位

（3）**正交振幅调制**：最复杂的调制方法。

***图 2-2 2-3 P44***



**信道极限容量**：失真，影响码元在信道传输速度因素：

（1）信道能通过的频率范围：**高频衰减影响码元之间的清晰界限，叫做码间串扰**；奈氏准则；传输有上限；

（2）**信噪比**：噪声是随机的，**信号的平均功率和噪声的平均功率比**，S/N，分贝为单位（dB）

​	**信噪比（dB） = 10 log10(S/N) （dB）**

**香农公式**：信道的极限信息传输速率**C = W log2(1+S/N) (bit/s)**，W是信道带宽（Hz），S为信道内信号平均功率，N为信道内部高斯噪声功率；

**信道的带宽或信噪比越大，信息的极限传输速率越高。（或者让每一个码元携带更多bit信息量）**



物理层下传输媒体：导引性型输媒体（电线）和非导引型传输媒体（电波）

（1）双绞线：屏蔽双绞线STP，导线越粗，通信距离越长；

（2）同轴电缆：抗干扰，提高速率

（3）光缆（100Gbit/s）

无线传输：短驳通信、无线电微波通信（中继站接力，传输质量高）、卫星通信（传播时延大）



**信道复用技术**：

（1）频分复用FDM：用户分配一定的频带后，通信中一直占用这个频带，**所有用户占用不同的带宽资源**（共享信道），复用器和分用器，复用用户增加，信道总带宽变大；

（2）时分复用TDM（同步DM）：每个用户所**占用的时间周期性出现**，将时间划分一段段**等长的时分复用帧**，用户无信息传输时候，有空闲时间但是不能利用，导致复用后信道利用率不高；

（3）统计时分复用STDM（异步DM）：改进版时分复用，动态分配时隙；各个用户的数据随时发往**集中器**缓存；

（4）波分复用WDM：**光的频分复用；**

（5）密集波分复用DWDM；

（6）码分复用CDM：共享信道，**码分多址CDMA；各用户之间不会干扰**；

CDMA中，每一个bit时间再划分m个间隔，称为码片chip；发送码片0，-1， 发送码片1，+1；扩频：直接序列扩频DSSS，调频扩频FHSS；向量S是站S的码片，T是其他的码片向量，两个不同码片序列**正交**，S \dot T = 1，        S \dot S =1。



**数字传输系统**：

（1）速率不统一；（2）不是同步传输

同步光纤网；同步传送信号；同步传递模块；



**宽带接入技术**：用户接入ISP，然后获得IP。有线/无线宽带接入；

非对称数字用户线ADSL技术：用数字技术对现有的模拟电话用户线进行改造；在用户线两端安装ADSL调制解调器（离线多音调DMT）；不保证固定的数据率；

无缝速率自适应技术SRA；高速数字用户线；

光纤同轴混合网HFC；

光纤到户FTTH，多宽带光纤接入方式FTTx技术：光配置线ODN给几十个用户共享一根线；1:32；



# 数据链路层：主机传输数据协议，MAC层传送帧

**主要是研究同一个局域网中，分组如何由一台主机传送到另一台主机。但是不经过路由器转发。**

链路：一个节点到相邻节点的一端物理线路，中间没有其他的交换节点；

数据链路：一条线路上**传输数据时**，除了必须的一条物理线路外，还需要一些**必要的通信协议来控制这些数据的传输**。把实现这些协议的硬件和软件加到链路上就构成了数据链路。最常用的是网络适配器来实现这些协议。规程和协议在数据链路层是同义词。

数据链路层：把**网络层交下来的数据**构成**帧**发送到链路上，以及把接受到的帧的数据取出上交到网络层，网络层协议数据单元是IP数据报（数据报/包/分组），**数据链路层传送的协议数据单元是帧**；



**数据链路层使用的信道**主要有以下两个：

（1）点对点信道：**一对一**的点对点通信方式；（结点A到结点B）

​	结点A的数据链路层把网络层交下来的IP数据报**添加首部和尾部封装成帧**；

​	结点A把封装好的帧**发送给结点B的数据链路层**；

​	若结点B的数据链路层**收到的帧无差错**，则从收到的帧中提取出IP数据报交给上面的网络层，否则丢弃帧；

（2）广播信道：1对多，连接主机多，使用专用的共享信道协议来协调这些主机的数据发送；



**三个基本问题：封装成帧、透明传输、差错检测**

（1）封装成帧：在一段数据前后分别**添加首部和尾部**。**接收端**收到物理层上交的**比特流**后，根据首部和尾部的标记，从比特流**识别帧的结束和开始**。帧即为数据链路层的数据传送单位。最大传送单元MTU是数据部分传送的上限；

控制字符：帧开始符SOH（01），帧结束符EOT（04）

（2）透明传输：传输数据中任何**8比特组合**不能和**帧定界控制字符的比特编码一样**，否则出现帧定界错误；当传输帧是文本文件时，无论从键盘输入什么字符，**数据部分都不会有SOH或EOT**，这样的帧很放心，所以就是透明传输；

当数据部分是非ASCII码的文本文件时（二进制的计算机程序或图像等），恰好和SOH或EOT一样，则提前终止，丢弃了剩余数据。为了解决这个问题，**在SOH或EOT前面加入转义字符ESC（1B），接收端的数据链路层把数据送往网络层之前删除这个插入的转义字符**，这种方法叫做字节填充或字符填充；

（3）差错检测：**比特传输中1到00到1，比特差错**；一段时间内，**传输错误的比特占所传输比特总数的比率**叫误码率BER；**提高信噪比降低误码率**；

循环冗余检验CRC：在数据M（k位）后面添加n位冗余码，用**二进制模2运算进行2^n乘M运算**，相当于在M后面加n个0；得到的**（k+n）位数除以收发双方事先商定的长度（n+1）的除数P**，得到商是Q，**余数为R（n位），R作为冗余码（这种作为检错而添加的冗余码称为帧检验序列FCS）拼接在数据M后面发出去**；

现在的CRC大多由硬件完成，处理迅速不延误数据传输，仅仅CRC则只能无差错接受；**可认为凡是接收端数据链路层accept接受的帧均无差错**；但是仅仅是比特差错，传输差错不是同样概念，还有帧丢失、帧重复、帧失序等，需在CRC基础上增加帧编号、确认和重传机制；（可靠性传输协议）



**点对点协议PPP**：目前最广泛使用的数据链路层协议

用户计算机和ISP进行通信时所使用的数据链路层协议。

（1）**PPP协议应满足的需求**

简单：IETF设计互联网结构时把最复杂的用在TCP协议中，网际协议IP比较简单；接收方每接受一个帧，进行CRC检验，正确则收下，反之丢弃；

封装成帧：PPP协议必须规定特殊的字符作为帧定界符（帧开始和结束符），以便接收端从收到的比特流找到帧的开始和结束位置；

透明性：爆炸数据传输的透明性；

多种网络层协议：在同一条物理链路上同时指出多层网络层协议的运行（如IP和IPX等）；

多种类型链路：必须能在多种类型的链路上运行；

差错检测：对接收端收到的帧检测；

检测连接状态：必须具有一种机制能及时自动检测出链路是否处于正常工作状态；

最大传送单元：每一种类型的点对点链路设置最大传送单元MTU；

网络地址协商：提供一种机制使通信的两个网络层的实体能通过协商知道或能配置彼此的网络层地址；

数据压缩协商：提供一种方法来协商使用数据压缩算法。

（2）**PPP协议的组成：**

一个将IP数据报封装成串行链路的方法；

一个用来建议、配置和测试数据链路连接的链路控制协议LCP；

一套网络控制协议NCP每一个协议支持不同的网络层协议。

（3）**PPP协议的帧格式**

连续两帧直接只需要一个标志字段；首部中地址字段A-0xFF，控制字段C-0x03，无意义，第四个字段是2字节协议字段，0x0021-IP数据报，0xC021-链路控制协议LCP，0x8021-网络层的控制数据，尾部第一个字段CRC帧建延续了FCS；

字节填充：转义字符0x7D：

​	0x7E变成0x7D,0x5E

​	0x7D变成0x7D,0x5D

​	出现ASCII码的控制字符，前面加入0x7D字节

零比特填充：5个连续的1填充一个0

（4）**PPP协议工作状态**

用户拨号接入ISP，发送链路控制协议LCP分组，建立LCP连接；接着进行网络配置，网络控制协议NCP给新接入用户分配一个临时IP地址，用户成为互联网一个有IP地址的主机；通信完毕后，NCP释放网络层连接，收回IP地址，接着LCF释放数据链路层连接；最后释放物理层连接。

***图3 -12 P81***



局域网优点：

（1）广播功能，从一个站点可以访问全网；

（2）便于系统的扩展和逐渐演变，各位置灵活可变

（3）提高可靠性、可用性、生存性

分类：星形网、环形网、总线网

共享信道：

（1）静态划分：各种复用，但是在局域网成本高；

（2）动态媒体（多点接入）：随机接入、受控接入

通信适配器（网卡）：计算机与外界局域网的连接；具备**存储器和处理器**，与计算机I/O总线并行传输；计算机发送IP数据报时，**由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网**。



**CSMA/CD协议** 载波监听多点接入碰撞检测：仅对半双工方式使用，**发送前监听，边发送边监听，发现碰撞后，立刻开始退避算法**；

不用建立连接直接通信，也不确认收到，不可靠交付；如果高层使用TCP，则经过一段时间TCP重新传输；为了避免同一时间只有一台计算机发送数据；CSMA/CD协议；

多点接入：总线型网络

载波监听：检测信道是否空闲

碰撞检测：载波监听时边发送边监听



3-24 假定站点A和B在同一个10Mb/s以太网网段上。这两个站点之间的传播时延为225比特时间。现假定A开始发送一帧，并且在A发送结束之前B也发送一帧。如果A发送的是以太网所容许的最短的帧，那么A在检测到和B发生碰撞之前能否把自己的数据发送完毕？换言之，如果A在发送完毕之前并没有检测到碰撞，那么能否肯定A所发送的帧不会和B发送的帧发生碰撞？（提示：在计算时应当考虑到每一个以太网帧在发送到信道上时，在MAC帧前面还要增加若干字节的前同步码和帧定界符）
答：设在t=0时A开始发送，在t=（64+8）*8=576比特时间，A应当发送完毕。t=225比特时间，B就检测出A的信号。只要B在t=224比特时间之前发送数据，A在发送完毕之前就一定检测到碰撞，就能够肯定以后也不会再发送碰撞了

如果A在发送完毕之前并没有检测到碰撞，那么就能够肯定A所发送的帧不会和B发送的帧发生碰撞（当然也不会和其他站点发生碰撞）。



3-25 在上题中的站点A和B在t=0时同时发送了数据帧。当t=255比特时间，A和B同时检测到发生了碰撞，并且在t=255+48=273比特时间完成了干扰信号的传输。A和B在CSMA/CD算法中选择不同的r值退避。假定A和B选择的随机数分别是rA=0和rB=1。试问A和B各在什么时间开始重传其数据帧？A重传的数据帧在什么时间到达B？A重传的数据会不会和B重传的数据再次发生碰撞？B会不会在预定的重传时间停止发送数据？

t=0时，A，B开始传输数据； 　

t=225比特时间，A和B同时检测到发生碰撞；

t=225+48=273比特时间，完成了干扰信号的传输；开始各自进行退避算法，

A：因为rA=0，则A在干扰信号传输完之后立即开始侦听t=273+225（传播时延）=498比特时间，A检测到信道开始空闲 t=498+96（帧间最小间隔）=594比特时间，A开始重传数据   -----第一问A的重传时间　　t=594+225 （传播时延）=819比特时间，A重传完毕 ----第二问A重传的数据帧到达B的时间　　 　　

B：因为rB=1，则B在干扰信号传输完之后1倍的争用期，即512比特时间才开始侦听　　t=273+512=785比特时间，B开始侦听 　若侦听空闲，则t=785+96（帧间最小间隔）=881比特时间，B开始重传数据。若侦听费空闲，则继续退避算法 　　又因为t=819比特时间的时候，A才重传数据完毕，所以B在785比特时间侦听的时候，肯定会侦听信道非空闲，即B在预定的881比特时间之前侦听到信道忙， 　　

所以，第四问的答案：B在预定的881比特时间是停止发送数据的。 

即第三问A重传的数据不会和B重传的数据再次发生碰撞。 



集线器：

（1）总线网CSMA/CD，允许同一时刻至多只允许一个站发送数据

（2）8或者16个接口

（3）集线器工作在物理层，每个接口仅仅转发比特

（4）自适应串音回波抵消

信道利用率a = 单程端到端地传播时延/帧的发送时间T0；

a趋近0时，一发生碰撞就可以检测出来；a值大则信道利用率小；以太网的帧长不能太短；

**极限信道利用**率Smax = 1/(1+a)；只有当a远小于1才能达到尽可能高的极限信道利用率；



**MAC层硬件地址**（MAC地址/物理地址）

每一台电脑都有MAC地址：6字节；

MAC帧：前面两个都是6个字节目的地址和原地址，第三个字段是2字节的类型（标记是什么协议），第四个字段是数据字段（46-1500）；第五个是FCS帧检验序列

扩展以太网： 使用网桥，根据收到的帧的MAC帧的目的地址进行转发和过滤；交换式集线器淘汰了网桥，在数据链路层工作；实际上是一个多接口的网桥；

以太网交换机的自学习功能：过滤：A向B发送一帧，先查找交换表，没有找到应该从哪个接口转发这一帧，接着交换机把这个帧的源地址A写入交换表，并向除接口1意外所有接口广播这个帧；CD丢弃帧，B接受；接着B向A发送一帧，交换表MAC地址有A，则可以到达A，这时不需要广播；一段时间后，只要CD发送帧，则交换表也会有CD经过的接口号，这样都能在交换表找到相应的转发接口；定期更新交换表，过期项目自动删除；

生成树协议STP：不改变网络实际拓扑，在逻辑上切除一些链路，使得一台主机到所有其他主机的路径都是无环路的树状结构；

虚拟局域网VLAN：只是局域网的一个服务，每个VLAN计算机可以处于不同局域网；

VLAN标记：前两个都是6字节的目的地址和源地址；然后是**4个字节的VLAN标记**，2个字节的类型，数据，4个字节的帧检验FCS序列

吉比特以太网：半双工方式下CSMA/CD，全双工不使用

10吉比特以太网：帧相同，仅在全双工方式工作；



# 网络层：IP协议，主机间的逻辑通信，路由器

网际协议IP，理解网络互连问题。网际控制报文协议ICMP，常见的路由协议，IPv6的主要特点。IP数据报=分组

网络层向上只提供**灵活的、无连接的、尽最大努力交付的数据报服务**。网络层不提供服务质量的承诺，即不可靠交付；**由主机端通信的运输层负责差错处理、流量控制等**。**进程之间通信的可靠性由运输层负责**。

**虚拟互连网络**：将网络互相连通起来需要一些中间设备：

（1）转发器：物理层使用的中间设备

（2）网桥（桥接器）：数据链路层

（3）路由器：网络层

（4）网关：网络层以上，连接两个不兼容的系统，并且需要高层的协议转换

不同异构的网络通过这些中间设备连接起来，利用IP协议使这些异构的网络在网络层上看起来是统一的网络，则称之为互联网；



**IP地址**：给每一台主机或路由器的**每一个接口**分配一个全世界范围**唯一**的**32位的标识符**

ICANN：互联网名字和数字分配机构

IP地址的编址方式：IP地址 ::= 网络号（唯一）+主机号

（1）分类的IP地址（2）子网的划分 （3）构成超网（无分类编址）

A类：0+7 网络号 24 主机号 最大主机数2^24-2（全0是本机 全1是所有主机）(1-126)

B类：10+14 网络号 16主机号 最大主机数2^16-2（128.1-191.255）

C类：110+21 网络号 8 主机号 最大主机数2^82（192.0.1-255.255.255）

D类：1110+28 多播地址

E类：1111+28 保留以后

***图 4-3 P121***

**IP地址特点**：

（1）**IP地址只分配网络号**，**路由器只根据主机所连接网络号来转发分组**，减少了路由表所占存储空间和差值路由表时间

（2）1个路由器至少有**2个IP地址**，IP地址标志一台主机和一条链路的接口

（3）用**转发器或网桥连接的若干局域网仍是一个网络**

（4）IP地址中所有分配的网络号**平等**



IP地址和硬件地址：

**IP地址在IP数据报首部；IP地址的IP数据报交给数据链路层就被封装成MAC帧；MAC帧在传送时使用的源地址和目的地址都是硬件地址，这两个硬件地址都在MAC帧首部；**

**MAC帧的首部尾部剥去后把MAC层的数据上交到网络层后，网络层才能在IP数据报首部找到源IP得知和目的IP地址；**

**在网络层和以上都是使用IP地址，数据链路层及以下使用MAC帧的数据**

***图 4-9b 122***



**ARP地址协议ARP（IP到硬件地址）：已经知道机器的IP地址，找到相应的硬件地址**，从网络层使用的IP地址，解析出数据链路层使用的硬件地址；在主机**ARP高速缓存**中存放一个从**IP地址到硬件地址的映射表**，并且经常动态更新（新增或超时删除）；主机对这种地址解析过程是不知道的，ARP是解决同一局域网上的主机或路由器；

由于全世界有各种各样的硬件地址，转换十分麻烦，所以统一使用IP编址；



**IP数据报格式**

IP协议版本4位（IPv4/6）、首部长度4位、区分服务8位、总长度16位（65535字节）、标识16位、标志3位（MF是还有分片或DF不能分片）、片偏移13位（以8个字节为偏移单位，长分组分片后，相对于元分组的相对位置）、生存时间8位、协议8位，首部检验和16位（计算数据报首段和然后取反码看是否等于0）、源地址目的地址都是16位

Ip层数据报总长度**不能超过数据链路层规定的最大传送单元MTU**（一般是1500字节），IP协议规定所有主机、路由器**必须接受长度不超过576字节的数据报**；



**IP层转发分组流程**

IP数据报仅有**源地址和目标地址的IP地址**，首先是主机的路由器，但是并没有完整的路径；如果目的地址与路由器直接相连，则直接交付；否则把**数据报先传给路由表中指明的下一跳路由器**，然后继续向后传输总能到达目标地址。



**划分子网**：两级地址到三级地址（网络号、子网号、主机号），相当于在IP地址的主机号再划分，不改变IP得知原来的网络号；

**子网掩码**：在IP地址本书无法看见子网划分消息，如何数据报到了路由器然后转发导相应子网呢，这时候需要子网掩码；从原来的16位主机号，拿8位作为子网号；24个1+8个0，前16位网络号加8位子网号，**子网掩码8个0代表主机号**，子网掩码和数据报的目的IP地址逐为相“与”得到子网网络地址；主机号全为0

A类地址默认子网掩码255.**0.0.0**，0xFF000000（32位2进制，8位16进制）24位主机号

B类地址默认子网掩码255.255.**0.0**，0xFFFF0000（32位2进制，8位16进制）16位主机号

C类地址默认子网掩码255.255.255.**0**，0xFFFFFF00（32位2进制，8位16进制）8位主机号



**使用子网时的分组转发**：路由器包括目的网络地址、子网掩码和下一跳地址

（1）从收到的数据报获得目的IP地址D

（2）判断能都直接交付，对路由器直接相连的网络检查：用各网络的子网掩码与D逐位相与，结果为N；若N与目的网络地址匹配，则把分组直接交付，将D转换成物理地址，包数据报封装成帧发送，转发任务结束；否则执行

（3）若路由表中有目的地址为D的特定主机路由，把数据报传输给路由表中所指明下一跳路由器，否则执行

（4）对路由表中每一行用其中的子网掩码和D逐位相与，结果为N，N与该行网络地址撇皮，数据报传送给该行指明的下一跳路由器；否则执行

（5）若路由表有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行

（6）报告转发分组出错



划分子网耗尽，需要CIDR无分类编址，消除ABC类地址和划分子网概念；IP地址 ::= 网络前缀+主机号

如128.13.32.0/20 的地址掩码前20位是网络前缀，也是地址掩码的20个1+12个0，则还有2^12个地址；

**最长匹配前缀**：在查找路由表匹配时可能不止一个匹配，选择最长前缀匹配；

**二叉线索查找路由器**：找出每个IP地址对应的唯一前缀，构造二叉搜索；



**网际控制报文协议ICMP**：在IP数据报的数据部分，ICMP报文有差错报告报文和询问报文；

ICMP报文格式：类型、代码、检验和

（1）**差错报文**：Ip数据报的首部和数据字段的前8字节+差错报告前8字节；

终点不可达：路由器或主机无法交付数据，向源点发送终点不可达

时间超过：生存时间为0

参数问题：数据报首部字段值不值正确，丢弃；

改变路由（重定向）：将数据报发送给另外的路由；

（2）**询问报文**：

会送请求和回答：主机或路由器向一个特定的目的主机发出询问；

时间戳请求和回答：请某台主机或路由器回答当前当前日期时间；

ICMP应用：PING



**网际组管理协议IGMP**：传送多播数据报，让连接在本地局域网的多播路由器知道本局域网上是否有主机参加或推出了某个多播组；多播路由选择协议：将多播数据报用最小代价传送到所有的组成员



**路由选择协议**：路由表的路由如何得出；

（1）内部网关协议IGP：在一个自治系统内部选择协议，如RIP、OSPF

**路由信息协议RIP**：基于距离向量（跳数<16）的路由选择，只适用小型网络，**选择最少路由器路径**，**仅有相邻路由器交换信息，本路路由器有全部信息，固定时间间隔交换路由信息**（3个特点）；P155距离向量算法；每个路由信息是20个字节，一个报文最多25个路由，版本4字节，报文最大长度4+20x25=504；

**开发最短路径优先OSPF**：为了克服PIR缺点（网络故障时，要很长时间才能通知所有路由器），使用分布式的链路状态协议；OSPF和RIP三个特点都不一样，所有路由器发送消息（洪泛法），**路由器只知道所有相邻路由器的链路状态，只有链路状态变化时候才使用洪泛法更新消息**；5个分组请求：**问候、数据库描述、链路状态请求、链路状态更新、链路状态确认**；

（2）外部网关协议EGP：源主机和目的主机不在一个自治系统

理想的路由算法：算法必须正确和完整、算法计算简单、能适应通信量和网络拓扑的变化、稳定性、公平、最佳、

边界网关协议BGP：交换的网络可达的信息到达某个网络所经过一系列自治系统；



路由器构成：多个输入端口和多个输出端口；**路由部分+分组转发部分（交换结构+输入端口+输出端口）**

输入端口：从线路接受分组、物理层处理、数据链路层处理、网络层处理分组排队（查表转发）、交换结构

输出端口：交换结构、网络层处理分组排队（查表转发）、数据链路层、物理层、向线路发送分组



虚拟网络专用网VPN：用于机构内部通信，通信保密



# 运输层：进程间的逻辑通信，TCP握手、拥塞控制

运输层协议特定、进程之间的通信和端口，UDP协议，TCP协议和可靠传输原理，停止等待协议和ARQ协议；TCP报文段的首部格式，TCP三个问题：滑动窗口、流量控制、拥塞控制机制。



**进程之间的通信**：运输层向上面的应用层提供通信服务。通信部分最高层，用户功能的最底层。从IP层来说，通信双端是两个主机，实际上，真正进行通信的是一台主机中的一个进程和另一台主机的一个进程在交换数据，也就是**两台主机中的应用进程互相通信**。通信的端点是主机中的**进程**。

网络层为主机直接提供逻辑通信，而运输层为应用进程之间提供端到端地逻辑通信；运输层要对收到的报文进行差错检测，有两种 运输协议：面向连接的TCP和无连接的UDP。



用户数据报协议UDP：传送数据前不需要建立连接

传输控制协议TCP：传送数据前需要建立连接，数据传送结束后释放连接，且不支持多播和广播服务



运输层的端口：通信一方无法识别对方机器的进程，**需要识别进程的终点**，把传送的报文交到目的主机的某个合适的目的端口；在协议栈层间的抽象的协议端口是**软件端口**。**硬件端口**是不同硬件设备交互的端口，软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址，端口号16位；**客户在发起通信请求时，必须先知道目标IP地址和端口号**。

（1）**服务器**端使用的端口号：熟知端口号（系统端口号）（0-1023，指派给TCP/IP的**最重要一些应用程序**）、登记端口号（1024-65535）；

（2）**客户端**使用的端口号：49152-65535，仅在客户进程进行时才动态选择，给客户进程暂时使用；



**用户数据报协议UDP**

（1）UDP是**无连接**的，发送数据前不需要建立连接，结束后也不是否连接，减少开销和发送时延；

（2）UDP是**尽最大努力交付（不可靠交付）**，主机不需要维持连接状态表；

（3）UDP是**面向报文**的。发送方的UDP对应用程序交下来的报文，在添加首部后下交付IP层；

（4）UDP**没有拥塞控制**，网络拥塞会使源主机发送速率降低 ，对于实时应用来说很重要；

（5）UDP支持**一对一、一对多、多对一、多对多的交互通信**；

（6）UDP首部**开销小**只有8字节，TCP有20字节。

**UDP首部格式**：数据字段+首部字段（8字节）

​	伪首部12（计算检验和将所有数据按反码加和填入）、源端口2、目的端口2、长度2、检验和2



**传输控制协议TCP**

（1）TCP是**面向连接**的运输层协议，传输前建立连接，传输后释放连接；

（2）每一条TCP连接只能有两个端点，**点对点传输**；

（3）提供**可靠服务**，无差错、不丢失、不重复，按时到达；

（4）**全双工通信**，允许通信双方的应用进程任何时候都能发送数据；

（5）**面向字节流**，流是流入到进程或从进程流出的字节序列，传输的数据虽然是一个数据块，但是可以看做是无结构的字节流；

（6）TCP**根据拥塞情况动态传输字节**；UDP是根据报文段字节数；

**TCP连接的两个端点叫套接字或插口：套接字socket ::= IP地址：端口号**

**每一条TCP连接是连接两个套接字；TCP连接是由软件协议提供的一种抽象，TCP连接的端点是很抽象的套接字，同一个IP地址可以有多个不同的TCP连接，同一个端口号也可以出现在不同的TCP连接中**



**可靠传输的工作原理：**

TCP发送的报文是交给IP层，但IP层只提供最大努力服务，也就是说，TCP下层是不可靠传输。

**停止等待协议**：传送的数据单元称为分组，停止等待就是**每发送完一个分组就停止发送，等待确认后再继续发送**；

1. 无差错情况：A发送分组M1，发完暂停发送，等待B确认；B收到M1向A发送确认。A收到确认后继续发送M2

2. 出现差错：B接受M1时检测出了差错丢弃M1，或者M1传输丢失，**B不做事；A等待一段时间后没有收到确认，则默认刚才发送的分组丢失**；设置一个**超时计时器**，A为每一个已发送分组都设置一个计时器，收到确认后撤销该计时器；

   （1）A发送一个分组后，**暂存保留已发送的分组的副本**，只有收到确认后菜清除副本；

   （2）分组和确认分组都要**标号**；

   （3）超时计时器**重传时间应该比分组传输的平均往返时间更长一些**；

3. 确认丢失和确认迟到：B发送的对M1的确认丢失了，则A不知道是出错还是丢失；这时A重传后，B收到了然后进行以下操作：

   （1）丢弃重复的分组

   （2）向A发送确认

**通过以上操作，我们在不可靠的传输网络上实现了可靠的通信；称为自动重传请求ARQ**（接收方不需要请求发送方重发出错的分组）。

4. 信道利用率：停止等待协议的优点是简单，缺点是信道利用率低；为了提高传输速率，使用**流水线传输**，这时要使用连续ARQ协议和滑动窗口协议；

   （1）连续ARQ协议：发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置；

   （2）滑动窗口协议



**TCP报文段的首部格式**

源端口和目的端口（各2字节）；序号（4字节）；确认号（4字节）；数据偏移（4位）；保留（6位）；窗口（2位）；检验和（2位）；紧急指针（2位）；选项

6个控制位：紧急URG（=1）；确认ACK（=1）；推送PUS；复位RST；同步SYN；终止FIN；

最大报文段长度MSS是TCP报文段中**数字字段**的最大长度；TCP报文段=数据字段+TCP首部（MSS默认536字节，主机都需要能接受报文段长度是536+20=556字节）

**TCP可靠传输的实现：**

以字节为单位的滑动窗口；接受缓存暂时存放按序到达但尚未被接受应用程序读取的数据，和未按序到达的数据；

超时重传时间的选择：计算报文段的往返时间RTT，往返时间加权平均更新RTTs；

RTTs = （1-a）xRTTs +a x new RTT

超时重传时间RTO = RTTs + 4 x RTTD

RTTD是RTT的偏差加权平均RTTD = (1-b) x RTTD + b x |RTTs - RTT|



**TCP流量控制**：如果数据传输过快，接收方来不及接受造成数据丢失；使用**滑动窗口**在TCP连接上实现对发送方的流量控制；**发送方的发送窗口不能超过接收方给出的接收窗口的数值，单位是字节；**

持续计时器：零窗口探测报文段（只携带1字节），接收方在确认信息时候告诉接收方；防止A未接受到调制窗口信息，导致死锁；

TCP传输效率：发送端何时发送报文也是一个问题；一是缓存字段达到MSS字节后组装成TCP报文段传输；二是由发送方应用进程指导；三是计时器；



**TCP拥塞控制**：对资源需求>可用资源；相对于流量控制端到端来说，拥塞控制是一个**全局性问题**；假定（1）数据传输单方向，对方只传输确认报文；（2）接收方有足够缓存，发送窗口大小由拥塞程度决定；

**慢开始、拥塞避免、快重传、快恢复**；

慢开始门限ssththresh状态变量：

cwnd<ssththresh，使用慢开始；

cwnd>ssththresh，停止慢开始，使用拥塞避免算法

cwnd=<ssththresh，都可以用；

1. 慢开始和拥塞避免：发送窗口等于拥塞窗口，判断网络拥塞的依据是是否出现了超时

   慢开始：当主机开始发送数据时候，不知道网络负荷情况，如果立刻把大量数据字节注入网络，则可能拥塞，最好**先探测一下，由小到大逐渐增大发送窗口**；

   初始拥塞窗口设置为1-2个发送方的最大报文段SMSS；每收到一个新的报文段后，增加最多一个SMSS数值，**每经过一个传输轮次，拥塞窗口cwnd就加倍**；

   拥塞避免：让拥塞窗口cwnd缓慢增大，每经过一个往返时间RTT就把发送方拥塞窗口加1MSS

2. 快重传：滑动窗口，**发送方依次发送分组但是连续接受了4个相同的确认（3-ACK）**，则立即进行重传丢失的分组；

   快恢复：因为知道3-ACK丢失了个别报文段，所以执行快恢复算法，**调制门限值ssthresh=cwnd /2=8**



主动队列管理AQM：路由器的分组丢弃策略；先进先出（尾部丢弃策略）；路由器尾部丢弃往往导致**一连串分组丢失，使得多个TCP连接进入慢开始，称为全局同步**，网络恢复正常后又开始拥塞；所以为了避免全局同步，有了主动队列管理AQM，即等待路由器队列长度达到一定值就开始丢弃；



**TCP运输连接管理：连接建立、数据传送、连接释放**

连接建立的三个问题：

（1）使得每一方都确知对方存在

（2）允许双方协商一些参数（最大窗口值，是否使用窗口扩大、时间戳及服务质量等）

（3）能够运输实体资源进行分配（缓存大小、连接表中的项目）

**TCP连接建立（握手）**，需要客户和服务器之间交换三个TCP报文段：客户A主动打开连接，服务器B被动打开

（1）A的TCP客户进程创建传输控制块TCB，向B发出连接请求报文，首部的同步位SYN=1，初始序列号seq=x

（2）B收到连接请求报文后，同意建立连接，向A发送确认；确认报文中ACK和SYN都为1，确认号ack=x+1，自己的初始序列号seq=y；

（3）TCP客户收到B的确认后，再给B确认，ACK=1，自己的序列seq=x+1，确认号ack=y+1，AB均处于ESTABLISHED状态

**TCP连接释放**：AB均处于ESTABLISHED状态

（1）A先向其TCP发出连接释放报文段，并停止发送数据，主动关闭TCP连接；把连接释放报文段首部的终止控制位FIN=1，序号seq=u，A进入FIN-WAIT 1状态，等待B的确认；

（2）B收到连接释放报文段后发出确认，确认号ack=u+1，ACK=1，序号seq=v，B进入CLOSE-WAIT状态，此时TCP处于半关闭状态，A无数据发送，但是B能传送数据到A；

（3）A收到B的确认后进入FIN-WAIT 2状态，等待B发出的连接释放报文段；若B无数据发送则通知TCP按释放连接，B发出的连接释放报文段，FIN=1，ACK=1，ack=u+1，seq=w，B进入LAST-ACK状态，等待A确认；

（4）A收到B的连接释放报文段后，发出确认，ACK=1，seq=u+1，ack=W+1；经过时间等待计时器TIME-WAIT后，2MSL4分钟后A进入CLOSED；B接受后也进入CLOSED。



# 应用层：应用间的通信，DNS、WWW

通信服务如何提供给应用进程来使用，应用进程**通过什么样的应用层协议来使用网络所提供的这些通信服务**。通过位于不同主机中的多个应用进程之间的通信和协同工作来完成。**客户是服务请求发，服务器是服务提供方**。

（1）**域名系统DNS——从域名解析IP地址**

（2）**万维网和HTTP协议**，以及万维网的两种不同信息搜索引擎

（3）电子邮件传输过程，SMTP协议和POP3协议、IMAP协议使用的场合

（4）动态主机配置协议DHCP特点

（5）网络管理的三个组成部分：SNMP、SMI、MIB

（6）系统调用和源域编程接口概念

（7）P2P文件系统



**域名系统DNS**：**互联网使用的命名系统**；用户与主机通信时很难记住IP**32位**主机地址，DNS将互联网**主机名转为IP地址**；DNS是**分布式系统**，基本上大多数名字都在本地解析，运行域名服务器程序叫做域名服务器，域名到IP地址的解析由**分布在互联网上的许多域名服务器共同完成**；

**每一个标号不超过63个字符；不区分大小写；多个标号组成完整域名不超过255个字符；**

域名三大类：国家顶级域名nTLD、通用顶级域名gTLD、基础结构域名（反向域名，用于反向域名解析）

com net org int edu gov mil

域名服务器：每一个服务器负责的范围叫区；每个区设置权限域名服务器，一个区的结点都能连通；区是域的子集；

（1）根域名服务器（13个域名）：最高层次，最重要，知道所有顶级域名服务器的域名和IP地址；采取任播技术（不同地点的主机IP地址相同），用户请求时，IP数据报交付给离源最近的一台主机；

（2）顶级域名服务器TLD：在该顶级域名服务器下注册二级域名；

（3）权限域名服务器：负责一个区的域名服务器

（4）本地域名服务器：当一台主机发出DNS查询请求时，这个查询请求报文发送给本地域名服务器，主域名服务器和辅助域名服务器；



**域名到IP地址解析过程**：当某一进程需要把主机名解析为IP地址时，**调用解析程序**，成为DNS的一个客户，**把待解析的域名放在DNS的请求报文中**，以**UDP用户数据报方式发送给本地域名服务**器，本地域名服务器在**查找域名**后，把对应的**IP地址放在回答报文**中返回；

域名解析过程中域名查询的两种方式：本地域名服务器、根域名服务器、顶级域名服务器、权限域名服务器

（1）**主机向本地域名服务器**查询采用**递归查询（踢皮球）**；如果主机所询问的本地域名服务器不知道被查询的域名IP地址，那么本地域名服务器以DNS客户身份向其他根域名服务器发送查询请求报文；

（2）**本地域名服务器向根域名服务器**查询采用**迭代查询（追根溯源）**；根域名服务器收到本地域名服务器请求时，给出查询的IP地址或者告诉本地域名服务器下一步向哪一个域名服务器进行查询。然后本地域名服务器再进行后续查询。

为了**提高DNS查询效率**，**减轻根域名服务器的符合，减少DNS查询报文数量**，在**域名服务器采用高速缓存**；



**文件传送协议FTP**：提高交互式文件传送，允许客户指定文件格式和类型、存取权限。在异构网络之间任意传送文件；基于TCP可靠运输服务，FTP主要功能是减少或消除**不同操作系统下处理文件的不兼容性**；

FTP客户服务器：主进程（打开端口21，等待客户发出连接请求、处理请求后终止，回到等待状态，继续处理其他请求）、从属进程（和主进程并发进行，在处理完请求后终止）

**FTP文件传输时要建立两个TCP连接：控制连接（21）、数据连接（20）**



**简单文件传送协议TFTP**：使用UDP数据报，内存小，每次512字节（最后一次可不足512字节）、数据报文按标号传输、支持ASCII或二进制传送、可以读写、首部简单；

**远程终端协议TELNET**：用户可以通过TCP连接注册到远地的另一台主机上；



**万维网WWW**：大规模、联机式的信息储藏所；分布式的超媒体系统，是超文本系统地扩充；客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档；

**统一资源定位符URL**：标志万维网上的各种文档，每一个文档在互联网都有唯一标识符URL；

协议：// 主机：端口/路径

**超文本协议HTTP**：应用层协议，使用**TCP连接**进行可靠传送，**HTTP本身不需要建立连接**，**但是用户请求时HTTP协议先和服务器建立TCP连接**；每个万维网网点都有一个服务器进程，不断监听TCP端口80，发现是否有浏览器发送连接建立请求；一旦监听到请求并建立TCP连接后，浏览器向万维网服务器请求某个页面，服务器响应请求，然后TCP连接释放；请求和响应遵守HTTP协议；**HTTP是面向对象，面向文本的协议**。

​	http：// 主机：端口/路径

**请求一个万维网文档时间是两个RTT时间+传输文档时间**；万维网客户**发起TCP连接**，万维网服务器响应请求；万维网客户收到后发送**HTTP请求报文**，万维网服务器返回**HTTP响应报文**，并开始传输文档；

万维网高速缓存/**代理服务器**：

（1）计算机向互联网服务器请求时，**已经和代理服务器建立TCP连接**，并向代理服务器发送HTTP请求报文；

（2）若代理服务器已经存放该请求的对象，则直接把这个对象直接放入HTTP响应报文，并发给计算机浏览器；

（3）否则，代理服务器代表用户浏览器，向源点服务器建立TCP连接，发送HTTP请求报文；

（4）源点服务器把请求对象放在HTTP响应报文返回给代理服务器；

（5）代理服务器收到对象后**复制存储在本地存储器**，然后放在HTTP响应报文，通过与计算机已建立的TCP连接返回该请求到浏览器。



请求报文：请求行（方法、请求资源的URL、HTTP版本）、首部行、实体主体（通常不用）

响应报文：状态行、首部行、实体主体（有些响应报文不用）

​	状态码：1xx（通知消息）、2xx（成功）、3xx（重定向）、4xx（客户差错）、5xx（服务器差错）

Cookie存放用户信息，浏览器能跟踪用户在该网站活动；



电子邮件：简单邮件传送协议SMTP，邮件读取协议POP3（都使用TCP连接传送邮件）

SMTP：连接建立、邮件传送、连接适当

POP3和IMAP