# 运输层

运输层协议特定、进程之间的通信和端口，UDP协议，TCO协议和可靠传输原理，停止等待协议和ARQ协议；TCP报文段的首部格式，TCP三个问题：滑动窗口、流量控制、拥塞控制机制。



**进程之间的通信**：运输层向上面的应用层提供通信服务。通信部分最高层，用户功能的最底层。从IP层来说，通信双端是两个主机，实际上，真正进行通信的是一台主机中的一个进程和另一台主机的一个进程在交换数据，也就是**两台主机中的应用进程互相通信**。通信的端点是主机中的**进程**。

网络层为主机直接提供逻辑通信，而运输层为应用进程之间提供端到端地逻辑通信；运输层要对收到的报文进行差错检测，有两种 运输协议：面向连接的TCP和无连接的UDP。



用户数据报协议UDP：传送数据前不需要建立连接

传输控制协议TCP：传送数据前需要建立连接，数据传送结束后释放连接，且不支持多播和广播服务



运输层的端口：通信一方无法识别对方机器的进程，**需要识别进程的终点**，把传送的报文交到目的主机的某个合适的目的端口；在协议栈层间的抽象的协议端口是**软件端口**。**硬件端口**是不同硬件设备交互的端口，软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址，端口号16位；**客户在发起通信请求时，必须先知道目标IP地址和端口号**。

（1）**服务器**端使用的端口号：熟知端口号（系统端口号）（0-1023，指派给TCP/IP的**最重要一些应用程序**）、登记端口号（1024-65535）；

（2）**客户端**使用的端口号：49152-65535，仅在客户进程进行时才动态选择，给客户进程暂时使用；



**用户数据报协议UDP**

（1）UDP是**无连接**的，发送数据前不需要建立连接，结束后也不是否连接，减少开销和发送时延；

（2）UDP是**尽最大努力交付（不可靠交付）**，主机不需要维持连接状态表；

（3）UDP是**面向报文**的。发送方的UDP对应用程序交下来的报文，在添加首部后下交付IP层；

（4）UDP**没有拥塞控制**，网络拥塞会使源主机发送速率降低 ，对于实时应用来说很重要；

（5）UDP支持**一对一、一对多、多对一、多对多的交互通信**；

（6）UDP首部**开销小**只有8字节，TCP有20字节。

**UDP首部格式**：数据字段+首部字段（8字节）

​	伪首部12（计算检验和将所有数据按反码加和填入）、源端口2、目的端口2、长度2、检验和2



**传输控制协议TCP**

（1）TCP是**面向连接**的运输层协议，传输前建立连接，传输后释放连接；

（2）每一条TCP连接只能有两个端点，**点对点传输**；

（3）提供**可靠服务**，无差错、不丢失、不重复，按时到达；

（4）**全双工通信**，允许通信双方的应用进程任何时候都能发送数据；

（5）**面向字节流**，流是流入到进程或从进程流出的字节序列，传输的数据虽然是一个数据块，但是可以看做是无结构的字节流；

（6）TCP**根据拥塞情况动态传输字节**；UDP是根据报文段字节数；

**TCP连接的两个端点叫套接字或插口：套接字socket ::= IP地址：端口号**

**每一条TCP连接是连接两个套接字；TCP连接是由软件协议提供的一种抽象，TCP连接的端点是很抽象的套接字，同一个IP地址可以有多个不同的TCP连接，同一个端口号也可以出现在不同的TCP连接中**



**可靠传输的工作原理：**

TCP发送的报文是交给IP层，但IP层只提供最大努力服务，也就是说，TCP下层是不可靠传输。

**停止等待协议**：传送的数据单元称为分组，停止等待就是**每发送完一个分组就停止发送，等待确认后再继续发送**；

1. 无差错情况：A发送分组M1，发完暂停发送，等待B确认；B收到M1向A发送确认。A收到确认后继续发送M2

2. 出现差错：B接受M1时检测出了差错丢弃M1，或者M1传输丢失，**B不做事；A等待一段时间后没有收到确认，则默认刚才发送的分组丢失**；设置一个**超时计时器**，A为每一个已发送分组都设置一个计时器，收到确认后撤销该计时器；

   （1）A发送一个分组后，**暂存保留已发送的分组的副本**，只有收到确认后菜清除副本；

   （2）分组和确认分组都要**标号**；

   （3）超时计时器**重传时间应该比分组传输的平均往返时间更长一些**；

3. 确认丢失和确认迟到：B发送的对M1的确认丢失了，则A不知道是出错还是丢失；这时A重传后，B收到了然后进行以下操作：

   （1）丢弃重复的分组

   （2）向A发送确认

**通过以上操作，我们在不可靠的传输网络上实现了可靠的通信；称为自动重传请求ARQ**（接收方不需要请求发送方重发出错的分组）。

4. 信道利用率：停止等待协议的优点是简单，缺点是信道利用率低；为了提高传输速率，使用**流水线传输**，这时要使用连续ARQ协议和滑动窗口协议；

   （1）连续ARQ协议：发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置；

   （2）滑动窗口协议



**TCP报文段的首部格式**

源端口和目的端口（各2字节）；序号（4字节）；确认号（4字节）；数据偏移（4位）；保留（6位）；窗口（2位）；检验和（2位）；紧急指针（2位）；选项

6个控制位：紧急URG（=1）；确认ACK（=1）；推送PUS；复位RST；同步SYN；终止FIN；

最大报文段长度MSS是TCP报文段中**数字字段**的最大长度；TCP报文段=数据字段+TCP首部（MSS默认536字节，主机都需要能接受报文段长度是536+20=556字节）

**TCP可靠传输的实现：**

以字节为单位的滑动窗口；接受缓存暂时存放按序到达但尚未被接受应用程序读取的数据，和未按序到达的数据；

超时重传时间的选择：计算报文段的往返时间RTT，往返时间加权平均更新RTTs；

RTTs = （1-a）xRTTs +a x new RTT

超时重传时间RTO = RTTs + 4 x RTTD

RTTD是RTT的偏差加权平均RTTD = (1-b) x RTTD + b x |RTTs - RTT|



**TCP流量控制**：如果数据传输过快，接收方来不及接受造成数据丢失；使用**滑动窗口**在TCP连接上实现对发送方的流量控制；**发送方的发送窗口不能超过接收方给出的接收窗口的数值，单位是字节；**

持续计时器：零窗口探测报文段（只携带1字节），接收方在确认信息时候告诉接收方；防止A未接受到调制窗口信息，导致死锁；

TCP传输效率：发送端何时发送报文也是一个问题；一是缓存字段达到MSS字节后组装成TCP报文段传输；二是由发送方应用进程指导；三是计时器；



**TCP拥塞控制**：对资源需求>可用资源；相对于流量控制端到端来说，拥塞控制是一个**全局性问题**；假定（1）数据传输单方向，对方只传输确认报文；（2）接收方有足够缓存，发送窗口大小由拥塞程度决定；

**慢开始、拥塞避免、快重传、快恢复**；

慢开始门限ssththresh状态变量：

cwnd<ssththresh，使用慢开始；

cwnd>ssththresh，停止慢开始，使用拥塞避免算法

cwnd=<ssththresh，都可以用；

1. 慢开始和拥塞避免：发送窗口等于拥塞窗口，判断网络拥塞的依据是是否出现了超时

   慢开始：当主机开始发送数据时候，不知道网络负荷情况，如果立刻把大量数据字节注入网络，则可能拥塞，最好**先探测一下，由小到大逐渐增大发送窗口**；

   初始拥塞窗口设置为1-2个发送方的最大报文段SMSS；每收到一个新的报文段后，增加最多一个SMSS数值，**每经过一个传输轮次，拥塞窗口cwnd就加倍**；

   拥塞避免：让拥塞窗口cwnd缓慢增大，每经过一个往返时间RTT就把发送方拥塞窗口加1MSS

2. 快重传：滑动窗口，**发送方依次发送分组但是连续接受了4个相同的确认（3-ACK）**，则立即进行重传丢失的分组；

   快恢复：因为知道3-ACK丢失了个别报文段，所以执行快恢复算法，**调制门限值ssthresh=cwnd /2=8**



主动队列管理AQM：路由器的分组丢弃策略；先进先出（尾部丢弃策略）；路由器尾部丢弃往往导致**一连串分组丢失，使得多个TCP连接进入慢开始，称为全局同步**，网络恢复正常后又开始拥塞；所以为了避免全局同步，有了主动队列管理AQM，即等待路由器队列长度达到一定值就开始丢弃；



**TCP运输连接管理：连接建立、数据传送、连接释放**

连接建立的三个问题：

（1）使得每一方都确知对方存在

（2）允许双方协商一些参数（最大窗口值，是否使用窗口扩大、时间戳及服务质量等）

（3）能够运输实体资源进行分配（缓存大小、连接表中的项目）

**TCP连接建立（握手）**，需要客户和服务器之间交换三个TCP报文段：客户A主动打开连接，服务器B被动打开

（1）A的TCP客户进程创建传输控制块TCB，向B发出连接请求报文，首部的同步位SYN=1，初始序列号seq=x

（2）B收到连接请求报文后，同意建立连接，向A发送确认；确认报文中ACK和SYN都为1，确认号ack=x+1，自己的初始序列号seq=y；

（3）TCP客户收到B的确认后，再给B确认，ACK=1，自己的序列seq=x+1，确认号ack=y+1，AB均处于ESTABLISHED状态

**TCP连接释放**：AB均处于ESTABLISHED状态

（1）A先向其TCP发出连接释放报文段，并停止发送数据，主动关闭TCP连接；把连接释放报文段首部的终止控制位FIN=1，序号seq=u，A进入FIN-WAIT 1状态，等待B的确认；

（2）B收到连接释放报文段后发出确认，确认号ack=u+1，ACK=1，序号seq=v，B进入CLOSE-WAIT状态，此时TCP处于半关闭状态，A无数据发送，但是B能传送数据到A；

（3）A收到B的确认后进入FIN-WAIT 2状态，等待B发出的连接释放报文段；若B无数据发送则通知TCP按释放连接，B发出的连接释放报文段，FIN=1，ACK=1，ack=u+1，seq=w，B进入LAST-ACK状态，等待A确认；

（4）A收到B的连接释放报文段后，发出确认，ACK=1，seq=u+1，ack=W+1；经过时间等待计时器TIME-WAIT后，2MSL4分钟后A进入CLOSED；B接受后也进入CLOSED。